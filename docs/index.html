<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>filesaver: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">filesaver
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">filesaver Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p align="center"><a class="anchor" id="md_README"></a> </p>
<p><img src="/design/AppIcon@256px.png" alt="" width="200" height="200" class="inline"/> </p>
<h1 align="center">filesaver</h1>
<p><img src="https://github.com/yamadapc/filesaver/workflows/CI/badge.svg" alt="CI" style="pointer-events: none;" class="inline"/></p>
<hr  />
<p>Very fast multi-threaded file size scanner utility written in C++ and Objective-C. Scans tens of thousands of files a second. It's able to scan my whole disk (which is 3.5+ million files) in close to a minute.</p>
<p>Doesn't care about memory usage at this point. It can generate a LevelDB index, which could solve this issue in the future.</p>
<p><img src="/screenshot.png" alt="" class="inline"/></p>
<p><img src="/diagram.svg" alt="" style="pointer-events: none;" class="inline"/></p>
<hr  />
<h2>What is it then?</h2>
<p>This is a macOS/CLI application that spawns several worker threads that keep scanning your disk to find files' sizes.</p>
<p>A single thread receives results and aggregates them to calculate directory sizes.</p>
<p>The workers work with two queues based on mutexes and condition variables (<b>data::WorkQueue</b>):</p>
<ul>
<li>An incoming files <b>workQueue</b> queue is polled for entries to scan</li>
<li>An output <b>resultsQueue</b> queue has scanned "FileEntry" objects written to (size/type/children)</li>
</ul>
<p>If the worker thread finds a directory, it'll also enqueue each of the directories' children onto the <b>workQueue</b>, then other workers can pick-up this recursive scan.</p>
<p>On the aggregation side, the consumer/reader thread <b>FileSaver::entryReader</b> reads entries from the resultQueue. It performs 3 operations on every entry:</p>
<ul>
<li>Set the number of pending children for this entry</li>
<li>Store the entry onto a cache, where they sit until finished and ready to be stored</li>
<li>If the entry is a file or is a directory with no pending children<ul>
<li>Iterate its path up until the root directory</li>
<li>For each parent<ul>
<li>Decrement the number of pending children</li>
<li>If the parent is finished, repeat this process for it</li>
</ul>
</li>
<li>Free the entry from memory (this will free parent paths that have finished)</li>
</ul>
</li>
<li>Update the size map for this file and all its parents<ul>
<li>This is a walk up the tree</li>
</ul>
</li>
</ul>
<p>When storage is enabled another thread reads from a storage queue and writes it to LevelDB.</p>
<hr  />
<h2>Performance and background</h2>
<p>At this point there aren't good benchmarks for the tool. I've profiled and optimized different parts and that so far it seems the performance is stellar for its use case of scanning an entire SSD disk and providing an interactive view of it (not necessarily indexing to a database).</p>
<p>The case where it'll be much slower than simple single-threaded scanners is if the number of files is small.</p>
<p>In this case, the thread sleeping and spawning threads that is performed will outweight its benefits, or that's how I understood it.</p>
<p>The tool I tried to use before was <a href="https://github.com/zevv/duc"><code>duc</code></a>, which is an awesome simple C tool for scanning files. It's very fast, but it's single-threaded.</p>
<p>To scan my entire MacBook's disk <code>filesaver</code> will:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Size scanned   </th><th class="markdownTableHeadNone">Files scanned   </th><th class="markdownTableHeadNone">Throughput in files (would accept queries)    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">221.5GB   </td><td class="markdownTableBodyNone">5.336.323   </td><td class="markdownTableBodyNone">51389/s   </td></tr>
</table>
<p>So it takes 100s to find all the sizes for all files in my disk and put it in a hash map for lookup.</p>
<h2>Building</h2>
<h3>Requirements</h3>
<ul>
<li>A modern C++ 17 compiler. (clang / GCC)</li>
<li>CMake</li>
<li>Conan package manager</li>
<li>XCode for the GUI</li>
</ul>
<h3>Library / CLI</h3>
<p>Build with CMake (or the Makefile wrapping it): </p><div class="fragment"><div class="line">make build-cli-release</div>
</div><!-- fragment --><h3>GUI</h3>
<p>The XCode project for the GUI is configured for macOS Catalina and newer.</p>
<div class="fragment"><div class="line">make build-gui-release</div>
</div><!-- fragment --><h2>License</h2>
<div class="fragment"><div class="line">The MIT License (MIT)</div>
<div class="line"> </div>
<div class="line">Copyright (c) 2019 Pedro Tacla Yamada</div>
<div class="line"> </div>
<div class="line">Permission is hereby granted, free of charge, to any person obtaining a copy</div>
<div class="line">of this software and associated documentation files (the &quot;Software&quot;), to deal</div>
<div class="line">in the Software without restriction, including without limitation the rights</div>
<div class="line">to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</div>
<div class="line">copies of the Software, and to permit persons to whom the Software is</div>
<div class="line">furnished to do so, subject to the following conditions:</div>
<div class="line"> </div>
<div class="line">The above copyright notice and this permission notice shall be included in</div>
<div class="line">all copies or substantial portions of the Software.</div>
<div class="line"> </div>
<div class="line">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</div>
<div class="line">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</div>
<div class="line">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</div>
<div class="line">AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</div>
<div class="line">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</div>
<div class="line">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN</div>
<div class="line">THE SOFTWARE.</div>
</div><!-- fragment --> </div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
